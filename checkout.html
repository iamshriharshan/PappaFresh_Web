<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Pappa Fresh</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Stripe -->
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body data-page="checkout">
    <!-- Simplified for clarity, keep your existing layout -->
    <div class="container my-5">
        <div class="row">
            <div class="col-lg-8">
                <!-- Shipping Form -->
                <form id="shipping-form">
                    <div class="mb-3">
                        <label class="form-label">Nome *</label>
                        <input type="text" class="form-control" id="firstName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Cognome *</label>
                        <input type="text" class="form-control" id="lastName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                </form>

                <!-- Card Payment -->
                <h5 class="mt-4">Metodo di Pagamento</h5>
                <div id="card-element" class="form-control" style="height:50px; padding-top:14px;"></div>
                <div id="card-errors" class="text-danger mt-2"></div>

                <!-- Terms -->
                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="terms" required>
                    <label class="form-check-label" for="terms">
                        Accetto i Termini e Condizioni *
                    </label>
                </div>

                <!-- Pay Button -->
                <button id="complete-order" class="btn btn-primary w-100 btn-lg mt-4">
                    Completa Ordine
                </button>
            </div>
        </div>
    </div>

    <!-- Stripe + JS -->
    <script>
        const stripe = Stripe("pk_test_YOUR_PUBLISHABLE_KEY"); // ✅ Replace with publishable key
        const elements = stripe.elements();
        const cardElement = elements.create("card");
        cardElement.mount("#card-element");

        // Display card errors
        cardElement.on("change", function(event) {
            document.getElementById("card-errors").textContent = event.error ? event.error.message : "";
        });

        document.getElementById("complete-order").addEventListener("click", async (e) => {
            e.preventDefault();

            // Call backend to create PaymentIntent
            const response = await fetch("/create-payment-intent", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ amount: 1000 }) // €10.00 for demo
            });
            const { clientSecret } = await response.json();

            // Confirm card payment
            const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                payment_method: {
                    card: cardElement,
                    billing_details: {
                        name: document.getElementById("firstName").value + " " + document.getElementById("lastName").value,
                        email: document.getElementById("email").value,
                    },
                },
            });

            if (error) {
                document.getElementById("card-errors").textContent = error.message;
            } else if (paymentIntent.status === "succeeded") {
                window.location.href = "/order-success";
            }
        });
    </script>
</body>
</html>
